generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = "file:../database/database.db"
}

model Worker {
  id            Int                   @id @default(autoincrement())
  name          String
  phone         String?
  wage          Float
  otRate        Float                 @default(0)
  isActive      Boolean               @default(true)
  balance       Float                 @default(0)
  joinedAt      DateTime              @default(now())
  createdAt     DateTime              @default(now())
  updatedAt     DateTime              @updatedAt
  inactiveFrom  DateTime?
  advances      Advance[]
  attendances   Attendance[]
  expenses      Expense[]
  salaries      Salary[]
  wageHistory   WageHistory[]
  statusHistory WorkerStatusHistory[]

  @@index([inactiveFrom])
}

model Attendance {
  id           Int              @id @default(autoincrement())
  date         DateTime
  status       AttendanceStatus
  otUnits      Float?           @default(0)
  note         String?
  wageAtTime   Float
  otRateAtTime Float
  workerId     Int
  createdAt    DateTime         @default(now())
  updatedAt    DateTime         @updatedAt
  worker       Worker           @relation(fields: [workerId], references: [id])

  @@unique([workerId, date])
  @@index([date])
}

model WageHistory {
  id            Int      @id @default(autoincrement())
  workerId      Int
  wage          Float
  otRate        Float
  effectiveFrom DateTime
  reason        String?
  createdAt     DateTime @default(now())
  worker        Worker   @relation(fields: [workerId], references: [id], onDelete: Cascade)

  @@index([workerId, effectiveFrom])
}

model Salary {
  id            Int             @id @default(autoincrement())
  workerId      Int
  cycleStart    DateTime
  cycleEnd      DateTime
  basePay       Float           @default(0)
  otPay         Float           @default(0)
  grossPay      Float           @default(0)
  totalAdvance  Float           @default(0)
  totalExpense  Float           @default(0)
  unpaidBalance Float           @default(0)
  netPay        Float           @default(0)
  totalPaid     Float           @default(0)
  status        SalaryStatus    @default(PENDING)
  paymentProof  String?
  signature     String?
  issuedAt      DateTime?
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt
  worker        Worker          @relation(fields: [workerId], references: [id])
  payments      SalaryPayment[]
}

model SalaryPayment {
  id        Int      @id @default(autoincrement())
  salaryId  Int
  amount    Float
  date      DateTime @default(now())
  proof     String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  salary    Salary   @relation(fields: [salaryId], references: [id], onDelete: Cascade)
}

model Advance {
  id        Int      @id @default(autoincrement())
  workerId  Int
  amount    Float
  reason    String?
  signature String?
  date      DateTime @default(now())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  worker    Worker   @relation(fields: [workerId], references: [id])

  @@index([workerId, date])
}

model ExpenseType {
  id       Int       @id @default(autoincrement())
  name     String    @unique
  expenses Expense[]
}

model Expense {
  id        Int         @id @default(autoincrement())
  workerId  Int
  amount    Float
  date      DateTime
  note      String?
  typeId    Int
  createdAt DateTime    @default(now())
  updatedAt DateTime    @updatedAt
  worker    Worker      @relation(fields: [workerId], references: [id])
  type      ExpenseType @relation(fields: [typeId], references: [id])

  @@index([workerId, date])
}

model WorkerStatusHistory {
  id            Int      @id @default(autoincrement())
  workerId      Int
  isActive      Boolean
  effectiveFrom DateTime
  reason        String?
  createdAt     DateTime @default(now())
  worker        Worker   @relation(fields: [workerId], references: [id], onDelete: Cascade)

  @@index([workerId, effectiveFrom])
}

enum AttendanceStatus {
  PRESENT
  HALF
  ABSENT
}

enum SalaryStatus {
  PENDING
  PARTIAL
  PAID
}
